name: Build Application Using Reusable Workflow - auto generate version number 

on:
  workflow_dispatch:
  # push:
    # branches: [ master, feature/* ]
  # pull_request:
    # branches: [ master ]

jobs:
  generate-version:
    name: Generate Version from POM
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.set-version.outputs.version }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Make Maven wrapper executable
      run: chmod +x ./mvnw

    - name: Generate version string
      id: set-version
      run: |
        BRANCH="${{ github.ref_name }}"
        POM_VERSION=$(./mvnw help:evaluate -Dexpression=project.version -q -DforceStdout)
        POM_VERSION_NO_SNAPSHOT=$(echo $POM_VERSION | sed 's/-SNAPSHOT//')
        BUILD_NUMBER="${{ github.run_number }}"
        VERSION="${BRANCH}-${POM_VERSION_NO_SNAPSHOT}-${BUILD_NUMBER}"
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "Generated version: ${VERSION}"

  call-reusable-build:
    name: Build using Reusable Workflow
    needs: generate-version
    uses: ./.github/workflows/reusable-build.yml
    with:
      # Use version from generate-version job
      version: ${{ needs.generate-version.outputs.version }}
      # Skip tests for feature branches, run tests for develop
      skip-tests: ${{ startsWith(github.ref, 'refs/heads/feature/') }}

  verify-build:
    name: Verify Build Results
    runs-on: ubuntu-latest
    needs: call-reusable-build
    steps:
    - name: Display build information
      run: |
        echo "Build completed successfully!"
        echo "Version: ${{ github.ref_name }}-${{ github.run_number }}"
        echo "Artifact: ${{ needs.call-reusable-build.outputs.artifact-name }}"
        echo "Status: ${{ needs.call-reusable-build.outputs.build-status }}"

    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: ${{ needs.call-reusable-build.outputs.artifact-name }}
        path: ./build-output

    - name: Verify artifact exists
      run: |
        echo "Verifying built artifact..."
        ls -lh ./build-output
        if [ -f ./build-output/*.jar ]; then
          echo "✅ JAR file found!"
        else
          echo "❌ JAR file not found!"
          exit 1
        fi

  deploy:
    name: Deploy Artifact
    runs-on: ubuntu-latest
    needs: call-reusable-build
    if: ${{ needs.call-reusable-build.outputs.build-status == 'success' }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download built artifact
      uses: actions/download-artifact@v4
      with:
        name: ${{ needs.call-reusable-build.outputs.artifact-name }}
        path: ./downloaded-artifact

    - name: Get version from generate job
      run: |
        echo "VERSION=${{ needs.generate-version.outputs.version }}" >> $GITHUB_ENV
        echo "Using version: ${{ needs.generate-version.outputs.version }}"

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'maven'

    - name: Make Maven wrapper executable
      run: chmod +x ./mvnw

    - name: Set Maven version
      run: |
        ./mvnw versions:set -DnewVersion=${{ env.VERSION }} -DgenerateBackupPoms=false

    - name: Deploy to Maven Repository
      env:
        MAVEN_REPO_URL: ${{ secrets.MAVEN_REPO_URL }}
        MAVEN_REPO_USERNAME: ${{ secrets.MAVEN_REPO_USERNAME }}
        MAVEN_REPO_PASSWORD: ${{ secrets.MAVEN_REPO_PASSWORD }}
      run: |
        ./mvnw deploy \
          -DskipTests=true \
          -DaltDeploymentRepository=remote-repo::default::${MAVEN_REPO_URL} \
          -s .github/maven-settings.xml
